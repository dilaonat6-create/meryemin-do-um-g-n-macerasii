<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Meryem için Pixel Macera</title>
<style>
body {
  margin: 0;
  background: #222;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: monospace;
}
canvas {
  background: #87ceeb;
  border: 4px solid #000;
}
#jumpBtn {
  position: absolute;
  bottom: 20px;
  right: 20px;
  padding: 15px 20px;
  font-size: 18px;
  background: #ffcc00;
  border: none;
  border-radius: 10px;
}
</style>
</head>
<body>

<canvas id="game" width="800" height="400"></canvas>
<button id="jumpBtn">ZIPLA</button>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let gravity = 0.6;
let frame = 0;
let passed = 0;
let obstacles = [];
let confetti = [];
let gameState = "start";

const startBtn = { x: 300, y: 210, w: 200, h: 50 };
const restartBtn = { x: 250, y: 230, w: 300, h: 40 };

/* ================= RESET ================= */

function resetGame() {
  obstacles = [];
  confetti = [];
  passed = 0;
  frame = 0;
  player.x = 100;
  player.y = 250;
  player.armExtend = 0;
  friend.x = 800;
  friend.armExtend = 0;
  gameState = "run";
}

/* ================= ENGELLER ================= */

function createObstacle() {
  obstacles.push({ x: 800, y: 290, w: 40, h: 30 });
}

function drawObstacles() {
  obstacles.forEach(o => {
    o.x -= 4;
    ctx.fillStyle = "#8b4513";
    ctx.fillRect(o.x, o.y, o.w, o.h);

    if (
      gameState === "run" &&
      player.x < o.x + o.w &&
      player.x + 30 > o.x &&
      player.y + 60 > o.y
    ) {
      gameState = "fail";
    }

    if (!o.passed && o.x + o.w < player.x) {
      o.passed = true;
      passed++;
    }
  });
  obstacles = obstacles.filter(o => o.x > -50);
}

/* ================= KARAKTERLER ================= */

const player = {
  x: 100,
  y: 250,
  vy: 0,
  armExtend: 0,

  jump() {
    if (this.y >= 250 && gameState === "run") this.vy = -12;
  },

  update() {
    this.vy += gravity;
    this.y += this.vy;
    if (this.y > 250) {
      this.y = 250;
      this.vy = 0;
    }
  },

  draw(walk=true) {
    let swing = walk ? Math.sin(frame * 0.2) * 3 : 0;

    ctx.fillStyle = "black";
    ctx.fillText("Meryem", this.x - 5, this.y - 10);

    ctx.fillStyle = "yellow";
    ctx.fillRect(this.x + 6, this.y, 18, 12);

    ctx.fillStyle = "#f1c27d";
    ctx.fillRect(this.x + 8, this.y + 12, 14, 14);
    ctx.fillStyle = "black";
    ctx.fillRect(this.x + 11, this.y + 17, 2, 2);
    ctx.fillRect(this.x + 17, this.y + 17, 2, 2);
    ctx.fillRect(this.x + 14, this.y + 23, 4, 1);

    ctx.fillStyle = "white";
    ctx.fillRect(this.x + 5, this.y + 26, 20, 20);

    ctx.fillStyle = "#f1c27d";
    ctx.fillRect(this.x - 2, this.y + 30 + swing, 7, 3);
    ctx.fillRect(this.x + 25, this.y + 30 - swing, 7 + this.armExtend, 3);

    ctx.fillStyle = "blue";
    ctx.fillRect(this.x + 6, this.y + 46 + swing, 6, 14);
    ctx.fillRect(this.x + 14, this.y + 46 - swing, 6, 14);
  }
};

const friend = {
  x: 800,
  y: 250,
  armExtend: 0,

  draw() {
    ctx.fillStyle = "black";
    ctx.fillText("Dila", this.x + 2, this.y - 10);

    ctx.fillStyle = "black";
    ctx.fillRect(this.x + 6, this.y, 18, 12);

    ctx.fillStyle = "#f1c27d";
    ctx.fillRect(this.x + 8, this.y + 12, 14, 14);
    ctx.fillStyle = "black";
    ctx.fillRect(this.x + 11, this.y + 17, 2, 2);
    ctx.fillRect(this.x + 17, this.y + 17, 2, 2);

    ctx.fillStyle = "brown";
    ctx.fillRect(this.x + 5, this.y + 26, 20, 20);

    ctx.fillStyle = "#f1c27d";
    ctx.fillRect(this.x - this.armExtend, this.y + 30, 7 + this.armExtend, 3);

    ctx.fillStyle = "black";
    ctx.fillRect(this.x + 6, this.y + 46, 6, 14);
    ctx.fillRect(this.x + 14, this.y + 46, 6, 14);
  }
};

/* ================= KONFETİ ================= */

function createConfetti() {
  for (let i = 0; i < 80; i++) {
    confetti.push({
      x: Math.random() * 800,
      y: -10,
      vy: Math.random() * 2 + 1,
      color: ["pink","red","yellow","white"][Math.floor(Math.random()*4)]
    });
  }
}

function drawConfetti() {
  confetti.forEach(c => {
    c.y += c.vy;
    ctx.fillStyle = c.color;
    ctx.fillRect(c.x, c.y, 4, 4);
  });
}

/* ================= SAHNELER ================= */

function drawStart() {
  ctx.fillStyle = "rgba(0,0,0,0.7)";
  ctx.fillRect(0,0,800,400);
  ctx.fillStyle = "#ffcc00";
  ctx.fillRect(startBtn.x, startBtn.y, startBtn.w, startBtn.h);
  ctx.fillStyle = "black";
  ctx.font = "28px monospace";
  ctx.textAlign = "center";
  ctx.fillText("BAŞLAA", 400, 245);
}

function drawFail() {
  ctx.fillStyle = "rgba(0,0,0,0.7)";
  ctx.fillRect(0,0,800,400);
  ctx.fillStyle = "white";
  ctx.font = "30px monospace";
  ctx.fillText("OYUN BİTTİ", 400, 170);
  ctx.fillStyle = "#ffcc00";
  ctx.fillRect(restartBtn.x, restartBtn.y, restartBtn.w, restartBtn.h);
  ctx.fillStyle = "black";
  ctx.font = "18px monospace";
  ctx.fillText("YENİDEN DENE AŞKIM YAPARSIN", 400, 258);
}

function drawEnd() {
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(0,0,800,400);

  ctx.fillStyle = "white";
  ctx.font = "22px monospace";
  ctx.textAlign = "center";
  ctx.fillText("İyi ki varsın Meryem,", 400, 180);
  ctx.fillText("sen benim en büyük şanslarımdan birisin.", 400, 215);
}

/* ================= INPUT ================= */

canvas.addEventListener("click", e => {
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;

  if (
    gameState === "start" &&
    x > startBtn.x && x < startBtn.x + startBtn.w &&
    y > startBtn.y && y < startBtn.y + startBtn.h
  ) resetGame();

  if (
    gameState === "fail" &&
    x > restartBtn.x && x < restartBtn.x + restartBtn.w &&
    y > restartBtn.y && y < restartBtn.y + restartBtn.h
  ) resetGame();
});

/* ================= LOOP ================= */

function update() {
  ctx.clearRect(0,0,800,400);

  if (gameState === "start") drawStart();

  if (gameState === "run") {
    player.update();
    player.draw(true);
    if (frame % 120 === 0) createObstacle();
    drawObstacles();
    if (passed >= 10) gameState = "meet";
  }

  if (gameState === "meet") {
    player.x += 1;
    if (friend.x > 430) friend.x -= 1;

    if (player.x > 340) player.armExtend += 0.3;
    if (friend.x < 460) friend.armExtend += 0.3;

    player.draw(false);
    friend.draw();

    if (player.x + 32 + player.armExtend >= friend.x - friend.armExtend) {
      gameState = "end";
      createConfetti();
    }
  }

  if (gameState === "end") {
    player.draw(false);
    friend.draw();
    drawConfetti();
    drawEnd(); // ← oyun burada kesin olarak biter
  }

  if (gameState === "fail") {
    player.draw(false);
    drawFail();
  }

  frame++;
  requestAnimationFrame(update);
}

/* ================= KONTROLLER ================= */

document.addEventListener("keydown", e => {
  if (e.code === "Space") player.jump();
});
document.getElementById("jumpBtn").onclick = () => player.jump();

update();
</script>
</body>
</html>
